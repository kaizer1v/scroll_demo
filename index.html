<!--

* every section needs to be pre-rendered and then shown / hidden based on the current section in view. appending / removing is a hard thing to do
* maybe one or 2 sections can be updated / moved
* use transition opacity to show and hide

-->
<!DOCTYPE html>
<html>
<head>
  <title>Scrolling Sections</title>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
<div class="container">
  <div id='graphic'>
    <div id='sections'>
      <section class="step">
        <div class="title">My Uber Data</div>
        I was curious about my cab usage history.<br/><br/>I found some really interesting insights. Here's a journey
        of my cab
      </section>

      <section class="step">
        <div class="title">Let's begin the journey</div>
        I started using Uber in the year 2015, farily at the same time when they had launched in Bangalore. At the time,
        the pain in negotiating with auto drivers was at it's peak. Where they demanded 300 INR for a 2 km ride.
      </section>

      <section class="step">
        <div class="title">...</div>
        Here's an overview of what I found when I analysed my Uber data.
        <!--
            total spendings: INR 93760.8 (almost a lakh)
            total km travelled: 4877 km (that's like Bangalore to Delhi and back)
            total # of trips: <that's a 50% cancellation rate ðŸ˜³)
              COMPLETED          339
              CANCELED           158
              UNFULFILLED         67
              DRIVER_CANCELED     24
            total inr / km rate: <that's 19.22 INR / km rate>
        -->
      </section>

      <section class="step">
        <div class="title">Rides</div>
        Lets look at the # rides I have taken
        <!--
          overview about completed & cancelled rides
          50% cancellation rate + requests that didn't go through were about 19%
          break-down by types of car
        -->
      </section>

      <section class="step">
        <div class="title">Um's, Ah's &amp; Uh's</div>
        I almost exclusively used these three fillers. Um's and Ah's made up over 80%, with Uh's trailing behind.
      </section>

      <section class="step">
        <div class="title">Fillers Over Time</div>
        I hoped that all these blunders were toward the beginning of my talk. And the data suggests that fewer fillers are used as I get into it. Perhaps the talk started out rough and improved as I found my groove.
      </section>

      <section class="step">
        <div class="title">Ramping Back Up</div>
        Unfortunately, the trend does not continue. Midway into the talk my Um's and Ah's spike. I continue to use them pretty consistently throughout the rest of the talk.
      </section>

      <section class="step">
        <div class="title">The Cough Effect</div>
        My theory is that at this critical halfway point in my talk, I heard a dry cough indicative of the audience's waning interest. This caused self-confidence to collapse and forced me out of my groove.<br/><br/>A competing theory is that I just hadn't practiced the last half of my speech as much.
      </section>

      <section class="step">
        <div class="title">Best of Luck to Me in 2015</div>
        The world may never know, or care, but hopefully these insights improve my speaking in 2015. Though preliminary results aren't looking so good.
      </section>
    </div>

    <!-- <span id='counter'>3</span> -->
    <!-- <svg id='vis'>
      <text x='50' y='40' id='counter' style='font-size: 4rem'>0</text>
      <circle r='50' fill='red' cx='70' cy='70'></circle>
    </svg> -->
    <div id='vis'>
      <!-- Viz over here -->
    </div>

    <div id="extra-space"></div>
  </div>
</div>


<script src="lib/d3.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.5.0/d3.min.js" integrity="sha512-+rnC6CO1Ofm09H411e0Ux7O9kqwM5/FlEHul4OsPk4QIHIYAiM77uZnQyIqcyWaZ4ddHFCvZGwUVGwuo0DPOnQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script src="js/scroller.js"></script>
<!-- <script src="js/sections.js"></script> -->
<!-- <script src="js/ditch.js"></script> -->
<script type="text/javascript">

  /** BUGS
   * activate control even on fast-scroll
   * some sections are being skipped when scrolling back up
   */

(function() {
  let svg = d3.select("#vis")
    .append('svg')

  svg.attr('width', 1000)
    .attr('height', 950)
    .attr('opacity', 1)

  svg.append('circle')
    .attr('cx', 30)
    .attr('cy', 30)
    .attr('r', 20)

}())

const fn1 = () => {
  let svg = d3.select('#vis').select('svg')

  svg.select('circle')
    .transition()
    .attr('cx', 30)
    .attr('cy', 30)
    .attr('r', 20)

}

const fn2 = () => {
  let svg = d3.select('#vis').select('svg')

  svg.select('circle')
    .transition()
    .attr('cx', 80)
    .attr('cy', 80)
    .attr('r', 30)

  const total_distance = 4877
  const total_spendings = 93760.8
  const g = svg.append('g')
  g.append('text').text(`Total distance travelled = ${total_distance}`).attr('x', 100).attr('y', 100)
  g.append('text').text(`Total spendings = ${total_spendings}`).attr('x', 100).attr('y', 150)
}


const clear = () => {
  // clear the svg for next section to load
}

// -----

let sss = scroller().container(d3.select('#graphic'))
sss(d3.selectAll('.step'))

const activationFunctions = [
  fn1,
  fn2,
  () => { d3.select('svg circle').transition().attr('fill', 'red') },
  () => { d3.select('svg circle').transition().attr('cx', 120) },
  () => { d3.select('svg circle').transition().attr('cy', 120) },
  () => { d3.select('svg circle').transition().attr('r', 60) },
  () => { d3.select('svg circle').transition().attr('r', 80).attr('fill', 'purple').attr('stroke', 'pink').attr('stroke-width', 5) },
  () => { console.log('fn 8') },
  () => { console.log('fn 9') }
]

let lastIndex = -1,
    activeIndex = 0;

const activate = (index) => {
  activeIndex = index
  let sign = (activeIndex - lastIndex) < 0 ? -1 : 1
  let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign)
  scrolledSections.forEach((i) => { activationFunctions[i]() })
  lastIndex = activeIndex
}

// setup event handling
sss.on('active', function (index) {
  // highlight current step text
  d3.selectAll('.step')
    .style('opacity', function (d, i) { return i === index ? 1 : 0.1; })

  // activate current section
  activate(index)    // plot is an object that updates a chart based on it's index
})

sss.on('progress', (index, progress) => {
  // do what you want to within each section index's progress
  console.log(index, progress)
})

</script>
</body>
</html>
